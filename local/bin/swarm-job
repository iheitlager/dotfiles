#!/usr/bin/env bash
# Copyright 2026 Ilja Heitlager
# SPDX-License-Identifier: Apache-2.0

# swarm-job - Unified job management for agent swarm
# Version: 2.0.0
#
# Usage: swarm-job <command> [options]
#
# Terminology:
#   - Issue: GitHub issue (external tracking)
#   - Job: Swarm queue item (cross-agent coordination)
#   - Task: LLM session item (in-agent execution)
#
# Commands:
#   new      Create a new job
#   claim    Claim a job from the queue
#   complete Mark a job as done
#   list     List jobs by status

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Get project context
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || {
    echo -e "${RED}Error: Not in a git repository${NC}" >&2
    exit 1
}

# Handle worktree paths
local_repo_name=$(basename "$REPO_ROOT")
local_repo_parent=$(dirname "$REPO_ROOT")

if [[ "$local_repo_parent" =~ ^(.+)-worktree$ ]]; then
    REPO_NAME=$(basename "${BASH_REMATCH[1]}")
elif [[ "$local_repo_name" =~ ^(.+)-worktree$ ]]; then
    REPO_NAME=$(basename "${BASH_REMATCH[1]}")
else
    REPO_NAME="$local_repo_name"
fi

SHARED_CONTEXT="$HOME/.local/state/agent-context/$REPO_NAME"
PENDING_DIR="$SHARED_CONTEXT/jobs/pending"
ACTIVE_DIR="$SHARED_CONTEXT/jobs/active"
DONE_DIR="$SHARED_CONTEXT/jobs/done"
LOCK_DIR="$SHARED_CONTEXT/jobs/.locks"
EVENTS_LOG="$SHARED_CONTEXT/events.log"

# Agent identity from environment (include whoami for multi-user)
WHOAMI="${CLAUDE_USER:-$(whoami)}"
AGENT_ID="${AGENT_ID:-${WHOAMI}}"
AGENT_MODEL="${AGENT_MODEL:-sonnet}"

# Ensure directories exist
ensure_dirs() {
    mkdir -p "$PENDING_DIR" "$ACTIVE_DIR" "$DONE_DIR" "$LOCK_DIR"
}

# Extract field from YAML
yaml_get() {
    local file="$1"
    local field="$2"
    grep "^${field}:" "$file" 2>/dev/null | sed "s/^${field}:[[:space:]]*//" | tr -d '"'
}

# Model capability tiers
get_model_tier() {
    case "$1" in
        opus)       echo 3 ;;
        sonnet)     echo 2 ;;
        haiku)      echo 1 ;;
        *)          echo 2 ;;
    esac
}

# Complexity to tier
get_complexity_tier() {
    case "$1" in
        complex)    echo 3 ;;
        moderate)   echo 2 ;;
        simple)     echo 1 ;;
        *)          echo 2 ;;
    esac
}

# Score a job for this agent
score_job() {
    local job_file="$1"
    local agent_tier=$(get_model_tier "$AGENT_MODEL")

    local recommended=$(yaml_get "$job_file" "recommended_model")
    local complexity=$(yaml_get "$job_file" "complexity")
    local priority=$(yaml_get "$job_file" "priority")

    local job_tier
    if [[ -n "$recommended" ]]; then
        job_tier=$(get_model_tier "$recommended")
    elif [[ -n "$complexity" ]]; then
        job_tier=$(get_complexity_tier "$complexity")
    else
        job_tier=2
    fi

    local score=0
    if [[ $job_tier -eq $agent_tier ]]; then
        score=100
    elif [[ $job_tier -lt $agent_tier ]]; then
        score=50
    else
        score=0
    fi

    case "$priority" in
        urgent) score=$((score + 40)) ;;
        high)   score=$((score + 30)) ;;
        medium) score=$((score + 20)) ;;
        low)    score=$((score + 10)) ;;
    esac

    echo $score
}

# ============================================================================
# NEW command
# ============================================================================
cmd_new() {
    local title=""
    local priority="medium"
    local complexity="moderate"
    local description=""
    local depends_on=""
    local edit_after=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            -p|--priority)    priority="$2"; shift 2 ;;
            -c|--complexity)  complexity="$2"; shift 2 ;;
            -d|--description) description="$2"; shift 2 ;;
            -D|--depends)     depends_on="$2"; shift 2 ;;
            -e|--edit)        edit_after=true; shift ;;
            -h|--help)        help_new; exit 0 ;;
            -*)               echo -e "${RED}Unknown option: $1${NC}" >&2; exit 1 ;;
            *)
                if [[ -z "$title" ]]; then
                    title="$1"
                else
                    echo -e "${RED}Unexpected argument: $1${NC}" >&2; exit 1
                fi
                shift ;;
        esac
    done

    if [[ -z "$title" ]]; then
        echo -e "${RED}Error: Title is required${NC}" >&2
        help_new
        exit 1
    fi

    # Validate priority
    case $priority in
        low|medium|high|urgent) ;;
        *) echo -e "${RED}Invalid priority: $priority${NC}" >&2; exit 1 ;;
    esac

    # Validate complexity
    case $complexity in
        simple|moderate|complex) ;;
        *) echo -e "${RED}Invalid complexity: $complexity${NC}" >&2; exit 1 ;;
    esac

    # Map complexity to model
    local recommended_model
    case $complexity in
        simple)   recommended_model="haiku" ;;
        moderate) recommended_model="sonnet" ;;
        complex)  recommended_model="opus" ;;
    esac

    ensure_dirs

    local job_id="job-$(date +%s)-$$"
    local job_file="$PENDING_DIR/$job_id.yaml"

    # Format depends_on
    local depends_block
    if [[ -n "$depends_on" ]]; then
        local depends_yaml=$(echo "$depends_on" | tr ',' '\n' | sed 's/^/  - /')
        depends_block="depends_on:
$depends_yaml"
    else
        depends_block="depends_on: []"
    fi

    [[ -z "$description" ]] && description="TODO: Add detailed description"

    cat > "$job_file" << EOF
id: $job_id
created: $(date -Iseconds)
created_by: ${AGENT_ID:-user}
priority: $priority
complexity: $complexity
recommended_model: $recommended_model
title: $title
description: |
  $description
$depends_block
claimed_by: null
claimed_at: null
completed_at: null
result: null
EOF

    echo -e "${GREEN}✓ Job created${NC}"
    echo ""
    echo "  ID:         $job_id"
    echo "  Priority:   $priority"
    echo "  Complexity: $complexity → $recommended_model"
    echo ""

    # Log creation
    echo "$(date -Iseconds) | ${AGENT_ID:-user} | CREATED | $job_id | $title" >> "$EVENTS_LOG"

    if [[ "$edit_after" == true ]]; then
        ${EDITOR:-vim} "$job_file"
    fi
}

help_new() {
    cat << EOF
Usage: swarm-job new "title" [OPTIONS]

Create a new job for the agent swarm.

Options:
    -p, --priority      low, medium, high, urgent (default: medium)
    -c, --complexity    simple, moderate, complex (default: moderate)
    -d, --description   Job description
    -D, --depends       Comma-separated job IDs this depends on
    -e, --edit          Open in \$EDITOR after creation
    -h, --help          Show this help

Complexity → Model:
    simple    → haiku   (docs, formatting, simple tests)
    moderate  → sonnet  (standard features, refactors)
    complex   → opus    (architecture, design, tricky bugs)

Examples:
    swarm-job new "Add --verbose flag to CLI"
    swarm-job new "Refactor data layer" -c complex -p high
    swarm-job new "Update tests" -D job-123,job-124
EOF
}

# ============================================================================
# CLAIM command
# ============================================================================
cmd_claim() {
    local job_id=""
    local dry_run=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            -n|--dry-run) dry_run=true; shift ;;
            -h|--help)    help_claim; exit 0 ;;
            -*)           echo -e "${RED}Unknown option: $1${NC}" >&2; exit 1 ;;
            *)            job_id="$1"; shift ;;
        esac
    done

    ensure_dirs

    # Find best job if none specified
    if [[ -z "$job_id" ]]; then
        local best_job=""
        local best_score=0

        for job_file in "$PENDING_DIR"/*.yaml; do
            [[ -f "$job_file" ]] || continue
            local score=$(score_job "$job_file")
            if [[ $score -gt $best_score ]]; then
                best_score=$score
                best_job=$(basename "$job_file" .yaml)
            fi
        done

        if [[ $best_score -gt 0 ]]; then
            job_id="$best_job"
        else
            echo -e "${YELLOW}No suitable jobs for $AGENT_ID ($AGENT_MODEL)${NC}"
            exit 0
        fi
    fi

    local job_file="$PENDING_DIR/${job_id}.yaml"
    local active_file="$ACTIVE_DIR/${job_id}.yaml"
    local lock_file="$LOCK_DIR/${job_id}.lock"

    if [[ ! -f "$job_file" ]]; then
        echo -e "${YELLOW}Job $job_id not found in pending queue${NC}" >&2
        return 1
    fi

    if [[ "$dry_run" == true ]]; then
        echo -e "${BLUE}Would claim:${NC} $job_id"
        echo -e "  Title: $(yaml_get "$job_file" "title")"
        echo -e "  Score: $(score_job "$job_file")"
        exit 0
    fi

    # Atomic claim with flock
    (
        if ! flock -n 200; then
            echo -e "${YELLOW}Job $job_id is being claimed by another agent${NC}" >&2
            exit 1
        fi

        if [[ ! -f "$job_file" ]]; then
            echo -e "${YELLOW}Job $job_id already claimed${NC}" >&2
            exit 1
        fi

        mv "$job_file" "$active_file"

        local timestamp=$(date -Iseconds)
        if [[ "$(uname)" == "Darwin" ]]; then
            sed -i '' "s/^claimed_by:.*/claimed_by: $AGENT_ID/" "$active_file"
            sed -i '' "s/^claimed_at:.*/claimed_at: $timestamp/" "$active_file"
        else
            sed -i "s/^claimed_by:.*/claimed_by: $AGENT_ID/" "$active_file"
            sed -i "s/^claimed_at:.*/claimed_at: $timestamp/" "$active_file"
        fi

        local title=$(yaml_get "$active_file" "title")
        echo "$timestamp | $AGENT_ID | CLAIMED | $job_id | $title" >> "$EVENTS_LOG"

        echo -e "${GREEN}✓${NC} Claimed: $job_id"
        echo -e "  Title: $title"

    ) 200>"$lock_file"
}

help_claim() {
    cat << EOF
Usage: swarm-job claim [JOB_ID] [OPTIONS]

Atomically claim a job from the pending queue.

Arguments:
    JOB_ID          Job to claim (auto-selects best match if omitted)

Options:
    -n, --dry-run   Show what would be claimed
    -h, --help      Show this help

Environment:
    AGENT_ID        Agent identifier (e.g., agent-1)
    AGENT_MODEL     Model tier: opus, sonnet, haiku

Examples:
    swarm-job claim                   # Claim best matching job
    swarm-job claim job-1737372800    # Claim specific job
    swarm-job claim --dry-run         # Preview selection
EOF
}

# ============================================================================
# COMPLETE command
# ============================================================================
cmd_complete() {
    local job_id=""
    local result=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            -r|--result) result="$2"; shift 2 ;;
            -h|--help)   help_complete; exit 0 ;;
            -*)          echo -e "${RED}Unknown option: $1${NC}" >&2; exit 1 ;;
            *)           job_id="$1"; shift ;;
        esac
    done

    if [[ -z "$job_id" ]]; then
        echo -e "${RED}Error: JOB_ID required${NC}" >&2
        help_complete
        exit 1
    fi

    ensure_dirs

    local active_file="$ACTIVE_DIR/${job_id}.yaml"
    local done_file="$DONE_DIR/${job_id}.yaml"

    if [[ ! -f "$active_file" ]]; then
        if [[ -f "$PENDING_DIR/${job_id}.yaml" ]]; then
            echo -e "${YELLOW}Job $job_id is still pending (not claimed)${NC}" >&2
            return 1
        fi
        echo -e "${YELLOW}Job $job_id not found in active queue${NC}" >&2
        return 1
    fi

    local title=$(yaml_get "$active_file" "title")
    local claimed_by=$(yaml_get "$active_file" "claimed_by")

    mv "$active_file" "$done_file"

    local timestamp=$(date -Iseconds)
    [[ -z "$result" ]] && result="success"

    if [[ "$(uname)" == "Darwin" ]]; then
        sed -i '' "s/^completed_at:.*/completed_at: $timestamp/" "$done_file"
        sed -i '' "s/^result:.*/result: $result/" "$done_file"
    else
        sed -i "s/^completed_at:.*/completed_at: $timestamp/" "$done_file"
        sed -i "s/^result:.*/result: $result/" "$done_file"
    fi

    echo "$timestamp | ${claimed_by:-$AGENT_ID} | COMPLETED | $job_id | $title" >> "$EVENTS_LOG"

    echo -e "${GREEN}✓${NC} Completed: $job_id"
    echo -e "  Title: $title"
    echo -e "  By: ${claimed_by:-$AGENT_ID}"
}

help_complete() {
    cat << EOF
Usage: swarm-job complete <JOB_ID> [OPTIONS]

Mark a job as completed.

Arguments:
    JOB_ID          Job to complete (required)

Options:
    -r, --result    Result status (default: success)
    -h, --help      Show this help

Examples:
    swarm-job complete job-1737372800
    swarm-job complete job-1737372800 -r "merged"
EOF
}

# ============================================================================
# LIST command
# ============================================================================
cmd_list() {
    local filter="all"

    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help) help_list; exit 0 ;;
            pending|active|done|all) filter="$1"; shift ;;
            -*)        echo -e "${RED}Unknown option: $1${NC}" >&2; exit 1 ;;
            *)         echo -e "${RED}Unknown filter: $1${NC}" >&2; exit 1 ;;
        esac
    done

    ensure_dirs

    if [[ "$filter" == "all" || "$filter" == "pending" ]]; then
        echo -e "${BOLD}${CYAN}Pending:${NC}"
        local found=false
        for job_file in "$PENDING_DIR"/*.yaml; do
            [[ -f "$job_file" ]] || continue
            found=true
            local job_id=$(basename "$job_file" .yaml)
            local title=$(yaml_get "$job_file" "title")
            local priority=$(yaml_get "$job_file" "priority")
            local complexity=$(yaml_get "$job_file" "complexity")
            local score=$(score_job "$job_file")

            local score_color="$RED"
            [[ $score -ge 100 ]] && score_color="$GREEN"
            [[ $score -ge 50 && $score -lt 100 ]] && score_color="$YELLOW"

            printf "  %s ${score_color}[%3d]${NC} [%s/%s] %s\n" \
                "$job_id" "$score" "${priority:-med}" "${complexity:-mod}" "$title"
        done
        [[ "$found" == false ]] && echo "  (none)"
        echo ""
    fi

    if [[ "$filter" == "all" || "$filter" == "active" ]]; then
        echo -e "${BOLD}${YELLOW}Active:${NC}"
        local found=false
        for job_file in "$ACTIVE_DIR"/*.yaml; do
            [[ -f "$job_file" ]] || continue
            found=true
            local job_id=$(basename "$job_file" .yaml)
            local title=$(yaml_get "$job_file" "title")
            local claimed_by=$(yaml_get "$job_file" "claimed_by")

            printf "  %s [%s] %s\n" "$job_id" "${claimed_by:-?}" "$title"
        done
        [[ "$found" == false ]] && echo "  (none)"
        echo ""
    fi

    if [[ "$filter" == "all" || "$filter" == "done" ]]; then
        echo -e "${BOLD}${GREEN}Done:${NC}"
        local found=false
        local count=0
        for job_file in "$DONE_DIR"/*.yaml; do
            [[ -f "$job_file" ]] || continue
            found=true
            ((count++))
            [[ $count -gt 5 ]] && continue  # Only show last 5

            local job_id=$(basename "$job_file" .yaml)
            local title=$(yaml_get "$job_file" "title")
            local result=$(yaml_get "$job_file" "result")

            printf "  %s [%s] %s\n" "$job_id" "${result:-done}" "$title"
        done
        [[ "$found" == false ]] && echo "  (none)"
        [[ $count -gt 5 ]] && echo "  ... and $((count - 5)) more"
    fi
}

help_list() {
    cat << EOF
Usage: swarm-job list [FILTER]

List jobs by status.

Filters:
    pending     Show pending jobs only
    active      Show active (claimed) jobs only
    done        Show completed jobs only
    all         Show all jobs (default)

The score shown for pending jobs indicates match quality for current agent:
    ${GREEN}[100+]${NC}  Perfect match for agent tier
    ${YELLOW}[ 50+]${NC}  Agent can handle (simpler job)
    ${RED}[  0 ]${NC}  Too complex for agent

Environment:
    AGENT_ID        Agent identifier
    AGENT_MODEL     Model tier (affects scoring)
EOF
}

# ============================================================================
# TAKE command (atomic check + create + claim)
# ============================================================================
cmd_take() {
    local issue_num=""
    local title=""
    local priority="medium"
    local complexity="moderate"
    local description=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            -i|--issue)       issue_num="$2"; shift 2 ;;
            -t|--title)       title="$2"; shift 2 ;;
            -p|--priority)    priority="$2"; shift 2 ;;
            -c|--complexity)  complexity="$2"; shift 2 ;;
            -d|--description) description="$2"; shift 2 ;;
            -h|--help)        help_take; exit 0 ;;
            -*)               echo -e "${RED}Unknown option: $1${NC}" >&2; exit 1 ;;
            *)
                # First positional arg is issue number
                if [[ -z "$issue_num" ]]; then
                    issue_num="$1"
                elif [[ -z "$title" ]]; then
                    title="$1"
                fi
                shift ;;
        esac
    done

    if [[ -z "$issue_num" ]]; then
        echo -e "${RED}Error: Issue number required${NC}" >&2
        help_take
        exit 1
    fi

    # Strip # prefix if present
    issue_num="${issue_num#\#}"

    ensure_dirs

    local global_lock="$LOCK_DIR/take.lock"

    # Atomic check + create + claim with global lock
    (
        if ! flock -n 200; then
            echo -e "${YELLOW}Another agent is taking an issue, try again${NC}" >&2
            exit 1
        fi

        # Check if issue already has a job (pending or active)
        local existing=""
        for job_file in "$PENDING_DIR"/*.yaml "$ACTIVE_DIR"/*.yaml; do
            [[ -f "$job_file" ]] || continue
            if grep -q "#${issue_num}[^0-9]" "$job_file" 2>/dev/null || \
               grep -q "#${issue_num}$" "$job_file" 2>/dev/null; then
                existing="$job_file"
                break
            fi
        done

        if [[ -n "$existing" ]]; then
            local existing_id=$(basename "$existing" .yaml)
            local existing_title=$(yaml_get "$existing" "title")
            local claimed_by=$(yaml_get "$existing" "claimed_by")

            echo -e "${YELLOW}✗ Issue #$issue_num already in queue${NC}"
            echo ""
            echo "  Job: $existing_id"
            echo "  Title: $existing_title"
            if [[ -n "$claimed_by" && "$claimed_by" != "null" ]]; then
                echo "  Claimed by: $claimed_by"
            else
                echo "  Status: pending (unclaimed)"
            fi
            echo ""
            echo "Options:"
            echo "  - Claim existing: swarm-job claim $existing_id"
            echo "  - Choose different issue"
            exit 1
        fi

        # Also check for open PRs (non-blocking warning)
        if command -v gh &>/dev/null; then
            local pr_check=$(gh pr list --search "#$issue_num in:body" --json number,title --jq '.[0].number // empty' 2>/dev/null)
            if [[ -n "$pr_check" ]]; then
                echo -e "${YELLOW}⚠️  Note: PR #$pr_check may address this issue${NC}"
            fi
        fi

        # Create the job
        [[ -z "$title" ]] && title="Issue #$issue_num"

        local recommended_model
        case $complexity in
            simple)   recommended_model="haiku" ;;
            moderate) recommended_model="sonnet" ;;
            complex)  recommended_model="opus" ;;
        esac

        local job_id="job-$(date +%s)-$$"
        local job_file="$ACTIVE_DIR/$job_id.yaml"  # Create directly in active (claimed)
        local timestamp=$(date -Iseconds)

        [[ -z "$description" ]] && description="From issue #$issue_num"

        cat > "$job_file" << EOF
id: $job_id
created: $timestamp
created_by: ${AGENT_ID:-user}
priority: $priority
complexity: $complexity
recommended_model: $recommended_model
title: $title (#$issue_num)
description: |
  $description
depends_on: []
claimed_by: ${AGENT_ID:-user}
claimed_at: $timestamp
completed_at: null
result: null
EOF

        echo "$timestamp | ${AGENT_ID:-user} | TAKE | $job_id | Issue #$issue_num - $title" >> "$EVENTS_LOG"

        echo -e "${GREEN}✓ Took issue #$issue_num${NC}"
        echo ""
        echo "  Job ID: $job_id"
        echo "  Title: $title"
        echo "  Claimed by: ${AGENT_ID:-user}"
        echo ""

    ) 200>"$global_lock"
}

help_take() {
    cat << EOF
Usage: swarm-job take <issue-num> [OPTIONS]

Atomically check if issue is available, create job, and claim it.
Prevents race conditions when multiple agents try to take the same issue.

Arguments:
    ISSUE_NUM       GitHub issue number (e.g., 123 or #123)

Options:
    -t, --title       Job title (default: "Issue #N")
    -p, --priority    low, medium, high, urgent (default: medium)
    -c, --complexity  simple, moderate, complex (default: moderate)
    -d, --description Job description
    -h, --help        Show this help

Examples:
    swarm-job take 123
    swarm-job take #123 -t "Add dark mode" -c moderate
    swarm-job take 456 -p high -c complex
EOF
}

# ============================================================================
# Main
# ============================================================================
show_help() {
    cat << EOF
Usage: swarm-job <command> [options]

Job management for the Claude agent swarm.

Terminology:
    Issue   GitHub issue (external tracking, source of truth)
    Job     Swarm queue item (cross-agent coordination, ephemeral)
    Task    LLM session item (in-agent execution, personal scratchpad)

Commands:
    new         Create a new job
    claim       Claim a job from the queue
    complete    Mark a job as done
    list        List jobs by status
    take        Atomically check + create + claim for an issue

Run 'swarm-job <command> --help' for command-specific options.

Environment:
    AGENT_ID        Agent identifier (e.g., agent-1)
    AGENT_MODEL     Model tier: opus, sonnet, haiku

Examples:
    swarm-job new "Add feature X" -p high
    swarm-job claim
    swarm-job complete job-1737372800
    swarm-job list pending
    swarm-job take 123 -t "Fix login bug" -p high
EOF
}

# Parse command
if [[ $# -eq 0 ]]; then
    show_help
    exit 0
fi

COMMAND="$1"
shift

case "$COMMAND" in
    new)      cmd_new "$@" ;;
    claim)    cmd_claim "$@" ;;
    complete) cmd_complete "$@" ;;
    list)     cmd_list "$@" ;;
    take)     cmd_take "$@" ;;
    -h|--help|help) show_help ;;
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}" >&2
        show_help
        exit 1
        ;;
esac
