#!/usr/bin/env bash
# launch-agent.sh
# Usage: ./launch-agent.sh [--close|-x] [--clean|-c] [--help|-h]
# Run from within your git repo

# set -e

SESSION="claude-agents"

# Detect repo root and name
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || {
    echo "Error: Not in a git repository"
    exit 1
}
REPO_NAME=$(basename "$REPO_ROOT")
REPO_PARENT=$(dirname "$REPO_ROOT")

# Worktree convention: ~/wc/code-analyzer-worktree/agent-1
WORKTREE_ROOT="$REPO_PARENT/${REPO_NAME}-worktree"
AGENT1_PATH="$WORKTREE_ROOT/agent-1"
AGENT2_PATH="$WORKTREE_ROOT/agent-2"
COORDINATOR_PATH="$WORKTREE_ROOT/coordinator"

SHARED_CONTEXT="${XDG_STATE_HOME:-$HOME/.local/state}/agent-context"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

show_help() {
    local HELP="cat"
    if command -v bat >/dev/null 2>&1; then
        HELP="bat --plain --language=help"
    fi
    
    $HELP << EOF
Usage: $(basename "$0") [OPTIONS] {start|stop|clean}

Launch coordinated Claude Code agents in tmux.

Options:
    -h, --help      Show this help message

Layout:
    Window 1 (agents):  agent-1 | agent-2 / coordinator
    Window 2 (shell-1): CLI for agent-1 worktree
    Window 3 (shell-2): CLI for agent-2 worktree

Navigation:
    Ctrl-b 1/2/3    Jump to window
    Ctrl-b ↑↓←→     Switch pane
    Ctrl-b z        Zoom pane (toggle)
    Ctrl-b d        Detach

EOF
}

close_session() {
    if tmux has-session -t "$SESSION" 2>/dev/null; then
        echo -e "${YELLOW}Killing tmux session: $SESSION${NC}"
        tmux kill-session -t "$SESSION"
        echo -e "${GREEN}✓ Session killed${NC}"
    else
        echo "No session to kill"
    fi
}

clean_worktrees() {
    echo "Checking worktrees for cleanup..."

    for agent in agent-1 agent-2; do
        local worktree_path="$WORKTREE_ROOT/$agent"
        local branch="$agent"

        if [[ ! -d "$worktree_path" ]]; then
            echo -e "  ${GREEN}✓${NC} $agent: no worktree"
            continue
        fi

        # Check for uncommitted changes
        pushd "$worktree_path" > /dev/null
        if [[ -n $(git status --porcelain) ]]; then
            echo -e "  ${RED}✗${NC} $agent: has uncommitted changes, skipping"
            popd > /dev/null
            continue
        fi
        popd > /dev/null

        # Check if branch is merged into main
        pushd "$REPO_ROOT" > /dev/null
        if git branch --merged main | grep -q "$branch"; then
            echo -e "  ${GREEN}✓${NC} $agent: branch merged, removing worktree"
            git worktree remove "$worktree_path" --force
            git branch -d "$branch" 2>/dev/null || true
        else
            echo -e "  ${YELLOW}!${NC} $agent: branch not merged into main, skipping"
        fi
        popd > /dev/null
    done

    # Clean up coordinator
    if [[ -d "$COORDINATOR_PATH" ]]; then
        rm -rf "$COORDINATOR_PATH"
        echo -e "  ${GREEN}✓${NC} coordinator: removed"
    fi

    # Remove worktree root if empty
    if [[ -d "$WORKTREE_ROOT" ]] && [[ -z "$(ls -A "$WORKTREE_ROOT")" ]]; then
        rmdir "$WORKTREE_ROOT"
        echo -e "${GREEN}✓ Worktree root removed${NC}"
    fi

    # Prune worktree references
    git worktree prune
}

setup_worktree() {
    local agent=$1
    local worktree_path=$2
    local branch="$agent"

    if [[ -d "$worktree_path" ]]; then
        echo -e "${GREEN}✓${NC} Worktree exists: $worktree_path"
        return 0
    fi

    # Ensure worktree root exists
    mkdir -p "$WORKTREE_ROOT"

    echo "Creating worktree for $agent..."

    if ! git show-ref --verify --quiet "refs/heads/$branch"; then
        echo "  Creating branch: $branch"
        git branch "$branch"
    fi

    git worktree add "$worktree_path" "$branch"

    pushd "$worktree_path" > /dev/null
    echo "  Setting up uv venv..."
    uv venv
    echo "  Linking claude skills..."
    link-claude

    echo -e "${GREEN}✓${NC} Worktree ready: $worktree_path"

    cat > ./CLAUDE.md << 'EOF'
# Agent NAME_PLACEHOLDER 

You are agent NAME_PLACEHOLDER in a multi-agent Claude Code setup. Your role is to implement specific features as directed by the coordinator agent.  

## Agent Layout

- **coordinator** (pane 0): You - monitoring and coordination
- **agent-1** (pane 1): Implementation agent, creates PRs, bumps versions
- **agent-2** (pane 2): Spike/TUI agent, integration work, creates PRs, no version bumps

## Your Responsibilities
1. **Follow Coordinator Instructions**: Execute tasks as assigned by the coordinator agent.
2. **Create PRs**: For any code changes, create pull requests against the main branch.
3. **Version Management**: (agent-1 only) Bump version numbers as needed.
4. **Document Findings**: (agent-2 only) Document any spikes or research in the shared context.
5. **Communicate Blockers**: Inform the coordinator of any issues

## State Directory
Keep your state in:
```
PATH_PLACEHOLDER/
├── status.md         # Current state of both agents
├── decisions.md      # Key decisions made
├── blockers.md       # Current blockers
└── events.log        # Timestamped event log
```

## Initial Actions
On startup:
1. Check the shared context directory for any updates from the coordinator.
2. Summarize your current task and status in `status.md`. 

## After Completing Tasks
After completing a task:
1. Update `status.md` with your new status.
2. Notify the coordinator of completion and any relevant details using
    the tmux messaging commands to the coordinator.

```bash
tmux send-keys -t claude-agents:agents.0 "NAME_PLACEHOLDER <MESSAGE>" && tmux send-keys -t claude-agents:agents.0 Enter
```
EOF

    # Replace placeholders with actual values
    sed -i "" "s|NAME_PLACEHOLDER|$agent|g; s|PATH_PLACEHOLDER|$SHARED_CONTEXT|g" ./CLAUDE.md

    popd > /dev/null
}

setup_coordinator() {
    mkdir -p "$COORDINATOR_PATH"

    # Create CLAUDE.md for coordinator
    cat > "$COORDINATOR_PATH/CLAUDE.md" << 'EOF'
# Coordinator Agent

You are the coordinator for a multi-agent Claude Code setup. Your role is to monitor and coordinate two implementation agents.

## Agent Layout

- **coordinator** (pane 0): You - monitoring and coordination
- **agent-1** (pane 1): Implementation agent, creates PRs, bumps versions
- **agent-2** (pane 2): Spike/TUI agent, integration work, creates PRs, no version bumps

## Commands to Monitor Agents

Check what agent-1 is doing:
```bash
tmux capture-pane -t claude-agents:agents.1 -p | tail -50
```

Check what agent-2 is doing:
```bash
tmux capture-pane -t claude-agents:agents.2 -p | tail -50
```

## Commands to Message Agents

Send instruction to agent-1 (use the two commands):
```bash
tmux send-keys -t claude-agents:agents.1 "Your message here" && tmux send-keys -t claude-agents:agents.1 Enter
```

Send instruction to agent-2 (use the two commands):
```bash
tmux send-keys -t claude-agents:agents.2 "Your message here" && tmux send-keys -t claude-agents:agents.2 Enter
```

## Your Responsibilities

1. **Monitor Progress**: Periodically check both agents' output
2. **Coordinate Handoffs**: When agent-1 merges a PR, notify agent-2 to rebase
3. **Track State**: Maintain notes in PATH_PLACEHOLDER/status.md
4. **Flag Blockers**: If an agent seems stuck, investigate and help
5. **Sync Context**: Share relevant discoveries between agents

## State Directory

Keep coordination state in:
```
PATH_PLACEHOLDER/
├── status.md         # Current state of both agents
├── decisions.md      # Key decisions made
├── blockers.md       # Current blockers
└── events.log        # Timestamped event log
```

## Event Patterns to Watch For

When you see in agent-1 output:
- "PR merged" or "✓ Merged" → Tell agent-2 to rebase
- "Version bumped to X.Y.Z" → Log it, notify agent-2
- "ERROR" or stuck patterns → Investigate

When you see in agent-2 output:
- "Need API from agent-1" → Check if agent-1 has it ready
- "Spike complete" → Document findings for agent-1

## Initial Actions

On startup:
1. Create PATH_PLACEHOLDER/ directory if needed
2. Check both agents' current state
3. Summarize what each is working on
EOF

    # Replace placeholders with actual values
    sed -i "" "s|PATH_PLACEHOLDER|$SHARED_CONTEXT|g" "$COORDINATOR_PATH/CLAUDE.md"

    # Create initial context directory
    mkdir -p "$SHARED_CONTEXT"
    
    cat > "$SHARED_CONTEXT/status.md" << EOF
# Agent Status

## Last Updated
$(date -Iseconds)

## Agent-1 (Implementation)
- Status: Starting
- Current task: Unknown
- Last PR: None

## Agent-2 (Spikes/TUI)
- Status: Starting  
- Current task: Unknown
- Last spike: None

## Pending Handoffs
- None

## Blockers
- None
EOF

    echo -e "${GREEN}✓${NC} Coordinator setup complete"
}

create_session() {
    if tmux has-session -t "$SESSION" 2>/dev/null; then
        echo "Session exists, attaching..."
        return 0
    fi

    echo "Creating tmux session with layout..."

    # Setup all paths
    setup_worktree "agent-1" "$AGENT1_PATH"
    setup_worktree "agent-2" "$AGENT2_PATH"
    setup_coordinator

    # Window 1: agents + coordinator
    # ┌──────────┬──────────┐
    # │ agent-1  │ agent-2  │
    # ├──────────┴──────────┤
    # │ coordinator         │
    # └─────────────────────┘
    
    tmux new-session -d -s "$SESSION" -n "agents" -c "$COORDINATOR_PATH"
    tmux split-window -h -t "$SESSION:agents.0" -c "$AGENT1_PATH"
    tmux split-window -v -t "$SESSION:agents.1" -c "$AGENT2_PATH"
    
    # Resize left pane (coordinator)
    tmux resize-pane -t "$SESSION:agents.0" -x 40%
    
    # Start claude in all panes
    tmux send-keys -t "$SESSION:agents.0" "claude" Enter
    tmux send-keys -t "$SESSION:agents.1" "source .venv/bin/activate && claude" Enter
    tmux send-keys -t "$SESSION:agents.2" "source .venv/bin/activate && claude" Enter

    # Window 2: agent-1 shell
    tmux new-window -t "$SESSION" -n "shell-1" -c "$AGENT1_PATH"
    tmux send-keys -t "$SESSION:shell-1" "source .venv/bin/activate" Enter

    # Window 3: agent-2 shell
    tmux new-window -t "$SESSION" -n "shell-2" -c "$AGENT2_PATH"
    tmux send-keys -t "$SESSION:shell-2" "source .venv/bin/activate" Enter

    # Focus on agents window, first pane
    tmux select-window -t "$SESSION:agents"
    tmux select-pane -t "$SESSION:agents.0"

    echo -e "${GREEN}✓ Session created${NC}"
}

main_flow() {
    # Main flow
    create_session

    echo ""
    echo -e "${GREEN}Layout:${NC}"
    echo "  Window 1 (agents):  agent-1 | agent-2 / coordinator"
    echo "  Window 2 (shell-1): CLI for agent-1 worktree"
    echo "  Window 3 (shell-2): CLI for agent-2 worktree"
    echo ""
    echo -e "${GREEN}Paths:${NC}"
    echo "  agent-1:     $AGENT1_PATH"
    echo "  agent-2:     $AGENT2_PATH"
    echo "  coordinator: $COORDINATOR_PATH"
    echo ""

    tmux attach -t "$SESSION"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        start)
            main_flow
            exit 0
            ;;
        stop)
            close_session
            exit 0
            ;;
        clean)
            close_session 2>/dev/null || true
            clean_worktrees
            exit 0
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done


