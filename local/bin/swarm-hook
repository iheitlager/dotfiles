#!/usr/bin/env python3
"""
swarm-hook - Unified hook for swarm-daemon integration with Claude Code

Usage:
    swarm-hook register    # SessionStart: Register agent
    swarm-hook hook        # PostToolUse: Track requests
    swarm-hook -h          # Show this help

Context = git repository (one daemon per repo)
Agent ID = <repo> (simple for now, can extend to <repo>.agent-N)
State files: ~/.local/state/agent-context/<repo>/

Part of the swarm suite:
- swarm-daemon: Background daemon for monitoring and coordination
- swarm-hook: Claude Code hook for event emission
- swarm-context: (future) Context management utilities
"""

import json
import os
import subprocess
import sys
from pathlib import Path


def get_git_repo_context():
    """Get git repository name as context identifier."""
    try:
        result = subprocess.run(
            ["git", "rev-parse", "--show-toplevel"],
            capture_output=True,
            text=True,
            check=True
        )
        repo_root = Path(result.stdout.strip())
        repo_name = repo_root.name.lstrip('.')

        # Check if this is a worktree
        git_dir = repo_root / ".git"
        if git_dir.is_file():
            parent_name = repo_root.parent.name
            if parent_name.endswith("-worktree"):
                repo_name = parent_name.replace("-worktree", "").lstrip('.')

        return repo_name
    except subprocess.CalledProcessError:
        return None


def get_agent_id(context):
    """Get agent ID from environment or generate from context."""
    agent_id = os.environ.get("AGENT_ID")
    if agent_id:
        return agent_id
    return context if context else "unknown"


def emit_event(agent_id, context, event_type, metadata):
    """Emit event to swarm-daemon (fire-and-forget)."""
    try:
        metadata_json = json.dumps(metadata)
        subprocess.run(
            ["swarm-daemon", "hook", event_type, metadata_json],
            env={**os.environ, "AGENT_ID": agent_id, "AGENT_CONTEXT": context or ""},
            capture_output=True,
            timeout=0.2,
            check=False
        )
    except (subprocess.TimeoutExpired, FileNotFoundError):
        pass  # Daemon not running or slow - that's OK


def cmd_register():
    """Handle SessionStart: Register agent with swarm-daemon."""
    context = get_git_repo_context()
    if not context:
        # Not in a git repo - allow but don't register
        print(json.dumps({"decision": "allow"}), flush=True)
        return

    agent_id = get_agent_id(context)

    # Emit AGENT_STARTUP event (fire-and-forget)
    metadata = {"context": context}
    emit_event(agent_id, context, "AGENT_STARTUP", metadata)

    # Return response with agent ID and context in environment
    response = {
        "decision": "allow",
        "env": {
            "AGENT_ID": agent_id,
            "AGENT_CONTEXT": context
        }
    }
    print(json.dumps(response), flush=True)


def cmd_hook():
    """Handle PostToolUse: Track request events."""
    # Read JSON input from stdin
    try:
        hook_input = json.loads(sys.stdin.read())
    except json.JSONDecodeError:
        print(json.dumps({"decision": "allow"}), flush=True)
        return
    except Exception:
        # Catch any other stdin reading errors
        print(json.dumps({"decision": "allow"}), flush=True)
        return

    # Get context and agent ID
    context = get_git_repo_context()
    if not context:
        print(json.dumps({"decision": "allow"}), flush=True)
        return

    agent_id = get_agent_id(context)

    # Extract tool information
    tool_name = hook_input.get("tool_name") or hook_input.get("tool", "unknown")

    # Emit REQUEST event with minimal metadata (fire-and-forget)
    metadata = {
        "tool": tool_name,
        "pid": os.getpid(),
        "context": context
    }
    emit_event(agent_id, context, "REQUEST", metadata)

    # Future: Add tool-specific event logic here
    # if tool_name == "Read":
    #     emit_event(agent_id, context, "TOOL_READ", {...})
    # elif tool_name == "Edit":
    #     emit_event(agent_id, context, "TOOL_EDIT", {...})
    # etc.

    # Always allow the operation
    print(json.dumps({"decision": "allow"}), flush=True)


def print_help():
    """Print help message."""
    print(__doc__)
    print("\nCommands:")
    print("  register    Register agent on session start (SessionStart hook)")
    print("              Emits: AGENT_STARTUP")
    print("              Returns: agent ID and context in environment")
    print()
    print("  hook        Track requests during session (PostToolUse hook)")
    print("              Emits: REQUEST events with tool, pid, context")
    print("              Always allows operation")
    print()
    print("Options:")
    print("  -h, --help  Show this help message")
    print()
    print("Files updated:")
    print("  ~/.local/state/agent-context/<repo>/events.log")
    print("  ~/.local/state/agent-context/<repo>/daemon/agent-state.yaml")
    print()
    print("Environment:")
    print("  AGENT_ID       Agent identifier (set by register, used by hook)")
    print("  AGENT_CONTEXT  Context/repo name (set by register)")


def main():
    """Main entry point."""
    try:
        if len(sys.argv) < 2:
            print("Usage: swarm-hook {register|hook|-h}", file=sys.stderr)
            sys.exit(1)

        command = sys.argv[1]

        if command in ("-h", "--help"):
            print_help()
            sys.exit(0)
        elif command == "register":
            cmd_register()
        elif command == "hook":
            cmd_hook()
        else:
            print(f"Unknown command: {command}", file=sys.stderr)
            print("Usage: swarm-hook {register|hook|-h}", file=sys.stderr)
            sys.exit(1)
    except Exception:
        # Hooks should never fail - always allow the operation
        print(json.dumps({"decision": "allow"}), flush=True)
        sys.exit(0)


if __name__ == "__main__":
    main()
