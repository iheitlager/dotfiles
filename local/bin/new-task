#!/usr/bin/env bash
# new-task
# Usage: ./new-task "title" [OPTIONS]
# Run from within your git repo

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

# Detect repo
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || {
    echo -e "${RED}Error: Not in a git repository${NC}"
    exit 1
}
REPO_NAME=$(basename "$REPO_ROOT")
SHARED_CONTEXT="$HOME/.local/state/agent-context/$REPO_NAME"

# Defaults
TITLE=""
PRIORITY="medium"
COMPLEXITY="moderate"
DESCRIPTION=""
DEPENDS_ON=""
EDIT_AFTER=false

show_help() {
    local HELP="cat"
    if command -v bat >/dev/null 2>&1; then
        HELP="bat --plain --language=help"
    fi
    
    $HELP << EOF
Usage: new-task "title" [OPTIONS]

Create a task for the agent swarm.

Arguments:
    title               Task title (required)

Options:
    -p, --priority      low, medium, high, urgent (default: medium)
    -c, --complexity    simple, moderate, complex (default: moderate)
    -d, --description   Task description (or edit after)
    -D, --depends       Comma-separated task IDs this depends on
    -e, --edit          Open in \$EDITOR after creation
    -h, --help          Show this help

Complexity → Recommended Model:
    simple              haiku   (docs, formatting, simple tests)
    moderate            sonnet  (standard features, refactors)
    complex             opus    (architecture, design, tricky bugs)

Examples:
    new-task "Add --verbose flag to CLI"
    new-task "Refactor data layer" -c complex -p high
    new-task "Update README" -c simple -e
    new-task "Update tests" -D task-123,task-124
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--priority)
            PRIORITY="$2"
            shift 2
            ;;
        -c|--complexity)
            COMPLEXITY="$2"
            shift 2
            ;;
        -d|--description)
            DESCRIPTION="$2"
            shift 2
            ;;
        -D|--depends)
            DEPENDS_ON="$2"
            shift 2
            ;;
        -e|--edit)
            EDIT_AFTER=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}"
            show_help
            exit 1
            ;;
        *)
            if [[ -z "$TITLE" ]]; then
                TITLE="$1"
            else
                echo -e "${RED}Unexpected argument: $1${NC}"
                show_help
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate
if [[ -z "$TITLE" ]]; then
    echo -e "${RED}Error: Title is required${NC}"
    show_help
    exit 1
fi

case $PRIORITY in
    low|medium|high|urgent) ;;
    *)
        echo -e "${RED}Error: Invalid priority: $PRIORITY${NC}"
        echo "Valid: low, medium, high, urgent"
        exit 1
        ;;
esac

case $COMPLEXITY in
    simple|moderate|complex) ;;
    *)
        echo -e "${RED}Error: Invalid complexity: $COMPLEXITY${NC}"
        echo "Valid: simple, moderate, complex"
        exit 1
        ;;
esac

# Map complexity to recommended model
case $COMPLEXITY in
    simple)   RECOMMENDED_MODEL="haiku" ;;
    moderate) RECOMMENDED_MODEL="sonnet" ;;
    complex)  RECOMMENDED_MODEL="opus" ;;
esac

# Generate task ID
TASK_ID="task-$(date +%s)-$$"
TASK_FILE="$SHARED_CONTEXT/tasks/pending/$TASK_ID.yaml"

# Ensure directories exist
mkdir -p "$SHARED_CONTEXT/tasks/pending"

# Format depends_on as YAML list
if [[ -n "$DEPENDS_ON" ]]; then
    DEPENDS_YAML=$(echo "$DEPENDS_ON" | tr ',' '\n' | sed 's/^/  - /')
    DEPENDS_BLOCK="depends_on:
$DEPENDS_YAML"
else
    DEPENDS_BLOCK="depends_on: []"
fi

# Set description placeholder if empty
if [[ -z "$DESCRIPTION" ]]; then
    DESCRIPTION="TODO: Add detailed description"
fi

# Create task file
cat > "$TASK_FILE" << EOF
id: $TASK_ID
created: $(date -Iseconds)
created_by: user
priority: $PRIORITY
complexity: $COMPLEXITY
recommended_model: $RECOMMENDED_MODEL
title: $TITLE
description: |
  $DESCRIPTION
$DEPENDS_BLOCK
claimed_by: null
claimed_at: null
completed_at: null
result: null
EOF

echo -e "${GREEN}✓ Task created${NC}"
echo ""
echo "  ID:          $TASK_ID"
echo "  Priority:    $PRIORITY"
echo "  Complexity:  $COMPLEXITY → $RECOMMENDED_MODEL"
echo "  File:        $TASK_FILE"
echo ""

# Log creation
if [[ -f "$SHARED_CONTEXT/events.log" ]]; then
    echo "$(date -Iseconds) | user | CREATED | $TASK_ID | $TITLE" >> "$SHARED_CONTEXT/events.log"
fi

# Open in editor if requested
if [[ "$EDIT_AFTER" == true ]]; then
    ${EDITOR:-vim} "$TASK_FILE"
fi
