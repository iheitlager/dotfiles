#!/usr/bin/env bash
# Copyright 2026 Ilja Heitlager
# SPDX-License-Identifier: Apache-2.0

# ai - One-shot AI queries from the command line
# Version: 0.5.0

set -e

# Source shared utilities
DOTFILES="${DOTFILES:-$HOME/.dotfiles}"
source "$DOTFILES/local/lib/shell-common.sh"

# Defaults
MODEL="sonnet"
RAW_OUTPUT=false

print_usage() {
    cat << 'EOF'
Usage: ai [OPTIONS] [PROMPT]

One-shot AI queries from the command line.

OPTIONS:
    -f FILE           Include file as context
    -c, --clipboard   Read from clipboard, copy response to clipboard
    --fast            Use haiku (quick/cheap)
    --opus            Use opus (complex tasks)
    --raw             Plain output (no markdown)
    -h, --help        Show this help

COMMANDS:
    --commit          Generate commit message for staged changes
    --review [FILE]   Review code (file or git diff)
    --diff            Explain current git diff
    --cmd "task"      Generate shell command
    --fix "error"     Help fix an error

EXAMPLES:
    ai "explain git rebase"
    ai -f config.yaml "is this valid"
    ai -c "fix this code"
    cat error.log | ai "summarize"
    ai --commit
    ai --diff
    ai --cmd "find files over 100mb"

EOF
    exit 0
}

# Simple prompt loader from commands/*.md
load_prompt() {
    local name="$1"
    local file="$DOTFILES/claude/config/commands/$name.md"
    [[ -f "$file" ]] || die "Command file not found: $file"
    awk '/^## Prompt/{f=1;next}/^##/{if(f)exit}f' "$file" | sed '/^$/d'
}

render() {
    if [[ "$RAW_OUTPUT" == true ]]; then cat; else render_md; fi
}

# Parse arguments
FILE_CONTEXT=""
CLIPBOARD=false
COMMAND=""
COMMAND_ARG=""
POSITIONAL=()

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)     print_usage ;;
        -f)            FILE_CONTEXT=$(cat "$2"); shift 2 ;;
        -c|--clipboard) CLIPBOARD=true; shift ;;
        --fast)        MODEL="haiku"; shift ;;
        --opus)        MODEL="opus"; shift ;;
        --raw)         RAW_OUTPUT=true; shift ;;
        --commit)      COMMAND="commit"; shift ;;
        --diff)        COMMAND="diff"; shift ;;
        --review)      COMMAND="review"; shift
                       [[ $# -gt 0 && ! "$1" =~ ^- ]] && { COMMAND_ARG="$1"; shift; } ;;
        --cmd)         COMMAND="cmd"; shift
                       [[ $# -gt 0 && ! "$1" =~ ^- ]] && { COMMAND_ARG="$1"; shift; } ;;
        --fix)         COMMAND="fix"; shift
                       [[ $# -gt 0 && ! "$1" =~ ^- ]] && { COMMAND_ARG="$1"; shift; } ;;
        -*)            die "Unknown option: $1" ;;
        *)             POSITIONAL+=("$1"); shift ;;
    esac
done

PROMPT="${POSITIONAL[*]}"

# Build prompt based on command
case "$COMMAND" in
    commit)
        DIFF=$(git diff --cached) || true
        [[ -z "$DIFF" ]] && die "No staged changes"
        PROMPT="$(load_prompt commit)"$'\n\n'"$DIFF"
        RAW_OUTPUT=true
        ;;
    diff)
        DIFF=$(git diff 2>/dev/null) || DIFF=$(git diff --cached 2>/dev/null) || true
        [[ -z "$DIFF" ]] && die "No changes"
        PROMPT="$(load_prompt diff)"$'\n\n'"$DIFF"
        ;;
    review)
        if [[ -n "$COMMAND_ARG" && -f "$COMMAND_ARG" ]]; then
            CONTENT=$(cat "$COMMAND_ARG")
        else
            CONTENT=$(git diff --cached 2>/dev/null) || CONTENT=$(git diff 2>/dev/null) || true
            [[ -z "$CONTENT" ]] && die "No changes to review"
        fi
        PROMPT="$(load_prompt review)"$'\n\n'"$CONTENT"
        ;;
    cmd)
        [[ -z "$COMMAND_ARG" && -z "$PROMPT" ]] && die "Usage: ai --cmd 'what to do'"
        PROMPT="$(load_prompt cmd)"$'\n\n'"Task: ${COMMAND_ARG:-$PROMPT}"
        RAW_OUTPUT=true
        ;;
    fix)
        [[ -z "$COMMAND_ARG" && -z "$PROMPT" ]] && die "Usage: ai --fix 'error message'"
        PROMPT="$(load_prompt fix)"$'\n\n'"${COMMAND_ARG:-$PROMPT}"
        ;;
esac

# Add clipboard content
if [[ "$CLIPBOARD" == true ]]; then
    CLIP=$(clipboard_paste) || true
    [[ -n "$CLIP" ]] && PROMPT="${PROMPT:+$PROMPT$'\n\n'}Clipboard:$'\n'$CLIP"
fi

# Add stdin
if [[ ! -t 0 ]]; then
    STDIN=$(cat)
    [[ -n "$STDIN" ]] && PROMPT="${PROMPT:+$PROMPT$'\n\n'}$STDIN"
fi

# Add file context
[[ -n "$FILE_CONTEXT" ]] && PROMPT="${PROMPT:+$PROMPT$'\n\n'}File:$'\n'$FILE_CONTEXT"

# Need something
[[ -z "$PROMPT" ]] && print_usage

# Call Claude
debug "Model: $MODEL, Prompt: ${#PROMPT} chars"
RESPONSE=$(printf '%s' "$PROMPT" | claude -p --model "$MODEL")

# Output
case "$COMMAND" in
    commit)
        echo -e "${BOLD}Commit message:${NC}"
        echo "$RESPONSE"
        echo
        if confirm "Commit?"; then
            git commit -m "$RESPONSE"
            success "Done"
        else
            echo "$RESPONSE" | clipboard_copy
            info "Copied to clipboard"
        fi
        ;;
    cmd)
        echo -e "${BOLD}Command:${NC} $RESPONSE"
        echo
        if confirm "Run?"; then
            eval "$RESPONSE"
        fi
        ;;
    *)
        if [[ "$CLIPBOARD" == true ]]; then
            echo "$RESPONSE" | clipboard_copy
            echo "$RESPONSE" | render
            success "Copied to clipboard" >&2
        else
            echo "$RESPONSE" | render
        fi
        ;;
esac
