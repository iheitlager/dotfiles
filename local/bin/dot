#!/usr/bin/env bash
# Copyright 2026 Ilja Heitlager
# SPDX-License-Identifier: Apache-2.0

# Install homebrew packages
BREWFILE="${XDG_DATA_HOME:-$HOME/.local/share}/Brewfile"

# Trap Ctrl-C and exit cleanly
trap 'echo ""; echo "‚ùå Installation interrupted by user"; exit 130' INT

print_usage() {
    local HELP="cat"
    if command -v bat >/dev/null 2>&1; then
        HELP="bat --plain --language=help"
    fi
    
    $HELP << EOF
Usage: dot [COMMAND] [OPTIONS]

COMMANDS:
    install <topic>   Run install.sh for a specific topic (e.g., vim, osx, vscode)
    list              List available topics with install.sh scripts
    status            Show installation status and outdated packages
    invalidate        Clear dotfiles caches (bash_env, bash_aliases, etc.)
    (none)            Install homebrew packages (default behavior)

OPTIONS:
    -n, --new         Force regeneration of Brewfile and install
    -x, --export      Only create Brewfile without installing
    -s, --skip        Skip using brew bundle, force package installation
    -v, --verbose     Show verbose output during operations
    -f, --file PATH   Specify custom Brewfile location (default: \$XDG_DATA_HOME/Brewfile)
    -h, --help        Show this help message

Example:
    dot                           # Install using existing Brewfile
    dot install vim               # Run vim/install.sh
    dot install osx               # Run osx/install.sh
    dot list                      # Show available topics
    dot status                    # Show what's installed and outdated
    dot invalidate                # Clear dotfiles caches
    dot -n                        # Regenerate Brewfile and install
    dot -x                        # Export current installations to Brewfile
    dot -v -n                     # Verbose output with new installation
    dot -f ~/my-brewfile          # Use custom Brewfile location

EOF
}

# Handle subcommands first
if [[ $# -gt 0 ]]; then
    case $1 in
        install)
            if [[ -z $DOTFILES ]]; then
                echo "‚ùå DOTFILES variable not set, exiting"
                exit 1
            fi
            if [[ -z $2 ]]; then
                echo "‚ùå Usage: dot install <topic>"
                echo "   Run 'dot list' to see available topics"
                exit 1
            fi
            TOPIC="$2"
            INSTALL_SCRIPT="$DOTFILES/$TOPIC/install.sh"
            if [[ -f "$INSTALL_SCRIPT" ]]; then
                echo "üîß Running install.sh for '$TOPIC'..."
                source "$INSTALL_SCRIPT"
                echo "‚úÖ Done installing '$TOPIC'"
                exit 0
            else
                echo "‚ùå No install.sh found for topic '$TOPIC'"
                echo "   Expected: $INSTALL_SCRIPT"
                echo "   Run 'dot list' to see available topics"
                exit 1
            fi
            ;;
        list)
            if [[ -z $DOTFILES ]]; then
                echo "‚ùå DOTFILES variable not set, exiting"
                exit 1
            fi
            echo "üìã Available topics with install.sh:"
            for script in "$DOTFILES"/*/install.sh; do
                if [[ -f "$script" ]]; then
                    topic=$(basename "$(dirname "$script")")
                    echo "   - $topic"
                fi
            done
            exit 0
            ;;
        status)
            echo "üìä Dotfiles Status"
            echo "=================="
            echo ""
            
            # Homebrew status
            echo "üç∫ Homebrew"
            echo "   Version: $(brew --version | head -1)"
            echo "   Prefix:  $(brew --prefix)"
            echo ""
            
            # Brewfile status
            BREWFILE="${XDG_DATA_HOME:-$HOME/.local/share}/Brewfile"
            if [[ -f "$BREWFILE" ]]; then
                formulae=$(grep -c '^brew ' "$BREWFILE" 2>/dev/null || echo 0)
                casks=$(grep -c '^cask ' "$BREWFILE" 2>/dev/null || echo 0)
                echo "üì¶ Brewfile: $BREWFILE"
                echo "   Formulae: $formulae"
                echo "   Casks:    $casks"
            else
                echo "üì¶ Brewfile: not found (run 'dot -x' to create)"
            fi
            echo ""
            
            # Outdated packages
            echo "üîÑ Outdated Packages"
            outdated=$(brew outdated 2>/dev/null)
            if [[ -n "$outdated" ]]; then
                outdated_count=$(echo "$outdated" | wc -l | tr -d ' ')
                echo "   $outdated_count package(s) can be upgraded (run 'brew upgrade')"
                echo "$outdated" | head -10 | while read line; do
                    echo "   ‚¨ÜÔ∏è  $line"
                done
                [[ $outdated_count -gt 10 ]] && echo "   ... and $((outdated_count - 10)) more"
            else
                echo "   ‚úÖ All packages up to date"
            fi
            echo ""
            
            # Topics status
            if [[ -n $DOTFILES ]]; then
                echo "üìÅ Topics"
                for dir in "$DOTFILES"/*/; do
                    topic=$(basename "$dir")
                    # Skip hidden dirs and special dirs
                    [[ "$topic" == ".git" || "$topic" == "script" || "$topic" == "docs" ]] && continue
                    
                    features=""
                    [[ -f "$dir/install.sh" ]] && features+="install "
                    [[ -f "$dir/brew_packages" ]] && features+="brew "
                    [[ -f "$dir/bash_aliases" ]] && features+="aliases "
                    [[ -f "$dir/bash_env" ]] && features+="env "
                    [[ -d "$dir/config" ]] && features+="config "
                    
                    if [[ -n "$features" ]]; then
                        printf "   %-12s [%s]\n" "$topic" "${features% }"
                    fi
                done
            fi
            echo ""
            
            # XDG paths
            echo "üóÇÔ∏è  XDG Paths"
            echo "   CONFIG: ${XDG_CONFIG_HOME:-~/.config}"
            echo "   DATA:   ${XDG_DATA_HOME:-~/.local/share}"
            echo "   STATE:  ${XDG_STATE_HOME:-~/.local/state}"
            echo "   CACHE:  ${XDG_CACHE_HOME:-~/.cache}"
            
            exit 0
            ;;
        invalidate)
            cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/dotfiles"
            if [[ -d "$cache_dir" ]]; then
                echo "üóëÔ∏è  Invalidating dotfiles caches..."
                for cache_file in "$cache_dir"/*.sh; do
                    if [[ -f "$cache_file" ]]; then
                        rm -f "$cache_file"
                        echo "   Removed: $(basename "$cache_file")"
                    fi
                done
                echo "‚úÖ Cache invalidated. Restart your shell to regenerate."
            else
                echo "‚ÑπÔ∏è  No cache directory found at: $cache_dir"
            fi
            exit 0
            ;;
    esac
fi

# Parse command line arguments
USE_NEW=false
EXPORT_ONLY=false
SKIP_BUNDLE=false
VERBOSE=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--new)
            USE_NEW=true
            shift
            ;;
        -x|--export)
            EXPORT_ONLY=true
            shift
            ;;
        -s|--skip)
            SKIP_BUNDLE=true
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -f|--file)
            BREWFILE="$2"
            shift 2
            ;;
        -h|--help)
            print_usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            print_usage
            exit 1
            ;;
    esac
done


if [[ -z $DOTFILES ]]  
then
    echo "‚ùå DOTFILES variable not set, exiting"
    exit 1
fi

# Check if export-only mode
if [[ "$EXPORT_ONLY" == true ]]; then
    echo "üìù Exporting current Homebrew installations to Brewfile..."
    if [[ "$VERBOSE" == true ]]; then
        brew bundle dump --file="$BREWFILE" --force --verbose
    else
        brew bundle dump --file="$BREWFILE" --force
    fi
    echo "‚úÖ Brewfile generated at $BREWFILE"
    exit 0
fi




# Check if Brewfile exists and --new flag is not set and --skip flag is not set
if [[ -f "$BREWFILE" && "$USE_NEW" == false && "$SKIP_BUNDLE" == false ]]; then
    echo "üì¶ Using existing Brewfile: $BREWFILE"
    echo "üîÑ Installing packages from Brewfile..."
    if [[ "$VERBOSE" == true ]]; then
        brew bundle --file="$BREWFILE" --verbose
    else
        brew bundle --file="$BREWFILE"
    fi
    exit 0
fi

# make sure we get the password early
if ! sudo -v; then
    echo "‚ùå sudo authentication failed or was cancelled"
    exit 1
fi

# start with brew itself
source $DOTFILES/homebrew/brew_install.sh 2>&1 || exit 1

# now process all topical brew packages
for src in $(find "$DOTFILES" -maxdepth 2 -name 'brew_packages')
do
    printf "  [ \033[00;34m..\033[0m ] Processing installer: $(basename $(dirname "$src"))\n"
    if [[ "$VERBOSE" == true ]]; then
        source "${src}" 2>&1 || exit 1
    else
        source "${src}" >/dev/null 2>&1 || exit 1
    fi
done

# Finally, export the Brewfile
printf "  [ \033[00;34m..\033[0m ] Exporting current Homebrew installations to Brewfile...\n"
if [[ "$VERBOSE" == true ]]; then
    brew bundle dump --file="$BREWFILE" --force --verbose
else
    brew bundle dump --file="$BREWFILE" --force
fi
echo "‚úÖ Brewfile generated at $BREWFILE"
echo "‚úÖ All done!"
