# Copyright 2026 Ilja Heitlager
# SPDX-License-Identifier: Apache-2.0

# =============================================================================
# TMUX CONFIGURATION
# =============================================================================
# Symlink: ~/.config/tmux/tmux.conf → ~/.dotfiles/tmux/config/tmux.conf

# =============================================================================
# GENERAL
# =============================================================================
# Enable mouse support (pane selection, resizing, scrolling)
# Note: With mouse mode on, use Shift+Cmd+Click to open hyperlinks in Ghostty
set -g mouse on

# True color support
set -g default-terminal "tmux-256color"

# Allow passthrough for OSC sequences (images, etc.)
set -g allow-passthrough on

# Enable native OSC 8 hyperlink support (tmux 3.4+)
# Note: In Ghostty, use Shift+Cmd+Click to open hyperlinks inside tmux
# (tmux captures mouse events in alternate screen mode, Shift bypasses this)
set -sa terminal-features ",xterm-ghostty:hyperlinks"
set -sa terminal-features ",xterm-ghostty:RGB"
set -sa terminal-features ",xterm-ghostty:usstyle"
set -sa terminal-features ",xterm-ghostty:extkeys"

# Extended keys
set -s extended-keys on
set -s extended-keys-format csi-u

# Clipboad via OSC 52
set -s set-clipboard on

# Start windows and panes at 1 (matches keyboard layout)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Keep window names as set — don't rename based on running process
set -g automatic-rename off

# Sync terminal (Ghostty) window title from per-session @title variable
# launch-agents sets @title; this re-emits it on every focus/window change
# Fallback to session name when @title is not set
set -g set-titles on
set -g set-titles-string "#{?#{@title},#{@title},#{session_name}}"

# Increase history limit
set -g history-limit 5000

# Faster command sequences (no delay for escape)
set -sg escape-time 0

# Enable focus events for vim/neovim
set -g focus-events on

# =============================================================================
# KEY BINDINGS
# =============================================================================
# Reload config with Ctrl-b r
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"

# Split panes with | and - (more intuitive)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# Switch panes with Alt+arrow (no prefix needed)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Switch windows with Shift+arrow (no prefix needed)
bind -n S-Left previous-window
bind -n S-Right next-window

# Resize panes with Ctrl+arrow
bind -n C-S-Left resize-pane -L 2
bind -n C-S-Right resize-pane -R 2
bind -n C-S-Up resize-pane -U 2
bind -n C-S-Down resize-pane -D 2

# =============================================================================
# COPY MODE (vi-style)
# =============================================================================
setw -g mode-keys vi
setw -g status-keys vi

# Enter copy mode with prefix + [
# Start selection with v, copy with y
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Y send -X copy-end-of-line
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"

# Rectangular selection with Ctrl-v
bind -T copy-mode-vi C-v send -X rectangle-toggle

# More vim-like navigation and selection
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line
bind -T copy-mode-vi Escape send -X cancel

# Paste with prefix + p
bind p paste-buffer

# =============================================================================
# STATUS BAR
# =============================================================================
set -g status on
set -g status-interval 5
set -g status-position bottom

# Colors (Catppuccin inspired)
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"

# Left side: session name
set -g status-left-length 40
set -g status-left "#[fg=#1e1e2e,bg=#89b4fa,bold] #S #[fg=#89b4fa,bg=#1e1e2e]"

# Right side: git branch, time
set -g status-right-length 100
set -g status-right "#[fg=#45475a]│#[fg=#a6e3a1] #{?#{==:#{pane_current_path},},~,#(cd #{pane_current_path} && git branch --show-current 2>/dev/null || echo '○')} #[fg=#45475a]│#[fg=#f9e2af] %H:%M #[fg=#45475a]│#[fg=#cdd6f4] %d %b "

# Window status
set -g window-status-format "#[fg=#6c7086] #I:#W "
set -g window-status-current-format "#[fg=#1e1e2e,bg=#cba6f7,bold] #I:#W #[fg=#cba6f7,bg=#1e1e2e]"
set -g window-status-separator ""

# Pane borders
set -g pane-border-style "fg=#45475a"
set -g pane-active-border-style "fg=#89b4fa"

# Message style
set -g message-style "bg=#89b4fa,fg=#1e1e2e"

# =============================================================================
# PLUGINS (TPM - Tmux Plugin Manager)
# =============================================================================
# Install: git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm
# Install plugins: prefix + I
# Update plugins: prefix + U

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'

# Yank settings (copy to system clipboard)
set -g @yank_selection_mouse 'clipboard'

# Initialize TPM (keep at bottom)
run '~/.config/tmux/plugins/tpm/tpm'
